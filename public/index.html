<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="/js/phprtc-ws-client.js"></script>
    <style>
        .sender {
            font-weight: bold;
            padding: 2px;
        }
    </style>
</head>
<body>

<div id="chat-messages" style="float: left;"></div>
<div style="float: right;">
    <form method="post" id="form-send-message">
        <textarea name="message"></textarea>
        <button type="submit">Send</button>
    </form>
</div>


<script>
    const wsChat = new RTC_Websocket("ws://localhost:9700/ws/chat", {}).connect();
    const elChatMessages = document.getElementById('chat-messages');
    const displayMessage = function (event) {
        const div = document.createElement('div');
        div.innerHTML = event.data.message;
        window.scroll(0, elChatMessages.scrollHeight);
        elChatMessages.append(div)
    }

    elChatMessages.innerHTML = "CHAT SERVER:";

    wsChat.setReconnectionInterval(5000);

    wsChat.onOpen(() => console.log('chat connection opened'));
    wsChat.onClose(() => console.log('chat connection closed'));

    wsChat.onMessage(message => {
        console.log(message);
    });

    wsChat.onEvent('welcome', message => {
        const div = document.createElement('div');
        div.innerHTML = message.data.message;
        window.scroll(0, elChatMessages.scrollHeight);
        elChatMessages.append(div)
    });

    wsChat.onEvent('room.join', displayMessage);
    wsChat.onEvent('room.leave', displayMessage);
    wsChat.onEvent('room.message', event => {
        event.data.message = `<span class="sender">@${event.meta['sender_name']}:</span> ${event.data.message}`
        displayMessage(event)
    });

    wsChat.onEvent('conn.rejected', () => {
        wsChat.close()
    });

    document.getElementById('form-send-message').onsubmit = function (e) {
        e.preventDefault();

        wsChat.send('room.message', this.querySelector('textarea').value);
    }
</script>
</body>
</html>