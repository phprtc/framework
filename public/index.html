<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Title</title>
    <script src="/js/phprtc-ws-client.js"></script>
    <style>
        .sender {
            font-weight: bold;
            padding: 2px;
        }
    </style>
</head>
<body>

<div id="chat-messages" style="float: left;"></div>
<div style="float: right;">
    <fieldset id="fieldset-room">
        <legend>Choose Room</legend>
        <form method="post" id="form-choose-room">
            <input name="username" value="Ahmard" placeholder="Username" required>
            <input name="room" value="phprtc" placeholder="Room" required>
            <button type="submit">Enter</button>
        </form>
    </fieldset>

    <fieldset id="fieldset-message" style="display: none">
        <legend>Message</legend>
        <form method="post" id="form-send-message">
            <textarea name="message"></textarea>
            <button type="submit">Send</button>
        </form>
    </fieldset>
</div>


<script>
    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';

    const initRoom = function (roomName) {
        const elChatMessages = document.getElementById('chat-messages');
        const websocket = RTC_Websocket.create(`${protocol}://${window.location.host}/ws/chat`, [], {
            username: document.querySelector('input[name="username"]').value
        });

        const room = websocket.joinRoom(roomName)
        const universal = websocket.joinRoom('universal')

        const displayMessage = function (event) {
            const div = document.createElement('div');
            div.innerHTML = event.data.message;
            window.scroll(0, elChatMessages.scrollHeight);
            elChatMessages.append(div)
        }

        elChatMessages.innerHTML = "CHAT SERVER:";

        websocket.setReconnectionInterval(5000);

        websocket.onOpen(() => {
            console.log('ws connection opened')
        });

        websocket.onClose(() => console.log('ws connection closed'));
        websocket.onMessage(message => console.log(message));

        const processMessage = function (event, customMessage = null) {
            const user_name = event.meta.user_info
                ? event.meta.user_info.username
                : 'You';

            event.data.message = `<i>@${user_name} ${customMessage ?? event.data.message}</i> `
            displayMessage(event)
        }

        room.on('welcome', message => {
            const div = document.createElement('div');
            div.innerHTML = message.data.message;
            window.scroll(0, elChatMessages.scrollHeight);
            elChatMessages.append(div)
        });

        room.on('joined', displayMessage);
        room.on('user_left', e => processMessage(e, 'left this room'));
        room.on('user_joined', e => processMessage(e, 'joined this room'));

        room.on('message', function (event) {
            const user_name = event.sender.info
                ? event.sender.info.username
                : 'You';

            event.data.message = `<span class="sender">@${user_name}:</span> ${event.data.message}`
            displayMessage(event)
        });

        room.on('conn.rejected', () => {
            room.close()
        });

        document.getElementById('fieldset-room').style.display = 'none'
        document.getElementById('fieldset-message').style.display = 'block'

        document.getElementById('form-send-message').onsubmit = function (e) {
            e.preventDefault();
            const textarea = this.querySelector('textarea')
            const message = textarea.value
            textarea.value = ''

            room.send(message);
        }
    }

    document.getElementById('form-choose-room').onsubmit = function (e) {
        e.preventDefault();
        const input = this.querySelector('input[name="room"]')
        initRoom(input.value)
    }

</script>
</body>
</html>